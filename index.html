<!DOCTYPE html>  
<html lang="fa" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>چت بات هوشمند</title>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
    <style>  
        @font-face {  
            font-family: 'B Titr';  
            src: url('https://cdn.fontcdn.ir/Font/Persian/Titr/BTitrBold.ttf') format('truetype');  
        }  
        
        @font-face {  
            font-family: 'B Nazanin';  
            src: url('https://cdn.fontcdn.ir/Font/Persian/Nazanin/BNazanin.ttf') format('truetype');  
        }  
        
        :root {  
            --primary-color: #6c5ce7;  
            --secondary-color: #a29bfe;  
            --text-color: #333;  
            --bg-color: #fff;  
            --message-bot: #f1f1f1;  
            --message-user: #d6e4ff;  
            --highlight-color: yellow;  
            --border-color: #ddd;  
            --icon-color: #555;  
            --search-bg: #f5f5f5;  
        }  
        
        .dark-mode {  
            --text-color: #f1f1f1;  
            --bg-color: #2c3e50;  
            --message-bot: #34495e;  
            --message-user: #2c3e50;  
            --border-color: #444;  
            --icon-color: #ddd;  
            --search-bg: #3d3d3d;  
        }  
        
        * {  
            margin: 0;  
            padding: 0;  
            box-sizing: border-box;  
        }  
        
        body {  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
            background-color: var(--bg-color);  
            color: var(--text-color);  
            transition: all 0.3s ease;  
        }  
        
        .container {  
            display: flex;  
            flex-direction: column;  
            height: 100vh;  
            max-width: 100%;  
            margin: 0 auto;  
            position: relative;  
        }  
        
        .header {  
            display: flex;  
            align-items: center;  
            justify-content: space-between;  
            padding: 15px;  
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));  
            color: white;  
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);  
            z-index: 100;  
        }  
        
        .header h1 {  
            font-family: 'B Titr', tahoma, Arial, sans-serif;  
            font-size: 1.5rem;  
            display: flex;  
            align-items: center;  
        }  
        
        .header h1 i {  
            margin-left: 10px;  
            color: #fff;  
            background: rgba(255, 255, 255, 0.2);  
            border-radius: 50%;  
            width: 30px;  
            height: 30px;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
        }  
        
        .header-icons {  
            display: flex;  
            gap: 15px;  
        }  
        
        .header-icons button {  
            background: none;  
            border: none;  
            color: white;  
            font-size: 1.2rem;  
            cursor: pointer;  
        }  
        
        .menu-btn {  
            background: none;  
            border: none;  
            color: white;  
            font-size: 1.5rem;  
            cursor: pointer;  
        }  
        
        .chat-container {  
            flex: 1;  
            overflow-y: auto;  
            padding: 20px;  
            display: flex;  
            flex-direction: column;  
            gap: 15px;  
        }  
        
        .message {  
            display: flex;  
            flex-direction: column;  
            max-width: 80%;  
            padding: 12px 15px;  
            border-radius: 15px;  
            position: relative;  
            margin-bottom: 5px;  
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);  
        }  
        
        .bot-message {  
            align-self: flex-start;  
            background-color: var(--message-bot);  
            border-bottom-left-radius: 5px;  
        }  
        
        .user-message {  
            align-self: flex-end;  
            background-color: var(--message-user);  
            border-bottom-right-radius: 5px;  
        }  
        
        .message-content {  
            word-wrap: break-word;  
            line-height: 1.5;  
        }  
        
        .message-time {  
            font-size: 0.7rem;  
            color: #777;  
            align-self: flex-end;  
            margin-top: 5px;  
        }  
        
        .message-stats {  
            font-size: 0.65rem;  
            color: #777;  
            margin-top: 5px;  
            padding-top: 5px;  
            border-top: 1px solid rgba(0, 0, 0, 0.1);  
        }  
        
        .message-actions {  
            position: absolute;  
            top: 5px;  
            left: 5px;  
            display: none;  
        }  
        
        .message:hover .message-actions {  
            display: block;  
        }  
        
        .delete-message {  
            background: none;  
            border: none;  
            font-size: 0.8rem;  
            color: #ff5252;  
            cursor: pointer;  
        }  
        
        .input-container {  
            display: flex;  
            flex-direction: column;  
            padding: 10px;  
            background-color: var(--bg-color);  
            border-top: 1px solid var(--border-color);  
        }  
        
        .input-tools {  
            display: flex;  
            gap: 10px;  
            padding: 5px 0;  
        }  
        
        .tool-button {  
            background: none;  
            border: none;  
            color: var(--icon-color);  
            font-size: 1.2rem;  
            cursor: pointer;  
            padding: 5px 10px;  
            border-radius: 5px;  
            transition: background 0.2s;  
        }  
        
        .tool-button:hover {  
            background-color: rgba(0, 0, 0, 0.05);  
        }  
        
        .main-input-area {  
            display: flex;  
            align-items: center;  
            gap: 10px;  
        }  
        
        .message-input {  
            flex: 1;  
            padding: 12px 15px;  
            border: 1px solid var(--border-color);  
            border-radius: 20px;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
            font-size: 1rem;  
            background-color: var(--bg-color);  
            color: var(--text-color);  
            resize: none;  
            max-height: 150px;  
            overflow-y: auto;  
        }  
        
        .message-input:focus {  
            outline: none;  
            border-color: var(--primary-color);  
        }  
        
        .send-button {  
            background-color: var(--primary-color);  
            color: white;  
            border: none;  
            width: 45px;  
            height: 45px;  
            border-radius: 50%;  
            cursor: pointer;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            font-size: 1.2rem;  
        }  
        
        .send-button:disabled {  
            background-color: var(--border-color);  
            cursor: not-allowed;  
        }  
        
        .side-menu {  
            position: fixed;  
            top: 0;  
            right: -300px;  
            width: 300px;  
            height: 100%;  
            background-color: var(--bg-color);  
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);  
            z-index: 1000;  
            transition: right 0.3s ease;  
            display: flex;  
            flex-direction: column;  
            padding-top: 60px;  
        }  
        
        .side-menu.active {  
            right: 0;  
        }  
        
        .side-menu-close {  
            position: absolute;  
            top: 20px;  
            left: 20px;  
            background: none;  
            border: none;  
            font-size: 1.5rem;  
            cursor: pointer;  
            color: var(--text-color);  
        }  
        
        .side-menu-tabs {  
            display: flex;  
            border-bottom: 1px solid var(--border-color);  
        }  
        
        .side-menu-tab {  
            flex: 1;  
            padding: 15px;  
            text-align: center;  
            cursor: pointer;  
            font-family: 'B Titr', tahoma, Arial, sans-serif;  
            color: var(--text-color);  
            border-bottom: 3px solid transparent;  
        }  
        
        .side-menu-tab.active {  
            border-bottom-color: var(--primary-color);  
            color: var(--primary-color);  
        }  
        
        .tab-content {  
            flex: 1;  
            overflow-y: auto;  
            padding: 15px;  
            display: none;  
        }  
        
        .tab-content.active {  
            display: block;  
        }  
        
        .search-container {  
            padding: 10px 0;  
            position: sticky;  
            top: 0;  
            background-color: var(--bg-color);  
            z-index: 10;  
        }  
        
        .search-input {  
            width: 100%;  
            padding: 10px;  
            border: 1px solid var(--border-color);  
            border-radius: 20px;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
            font-size: 0.9rem;  
            background-color: var(--search-bg);  
            color: var(--text-color);  
        }  
        
        .history-message {  
            padding: 10px;  
            border-bottom: 1px solid var(--border-color);  
            cursor: pointer;  
        }  
        
        .history-message:hover {  
            background-color: rgba(0, 0, 0, 0.05);  
        }  
        
        .history-content {  
            font-size: 0.9rem;  
            white-space: nowrap;  
            overflow: hidden;  
            text-overflow: ellipsis;  
        }  
        
        .history-date {  
            font-size: 0.7rem;  
            color: #777;  
            margin-top: 5px;  
        }  
        
        .model-item {  
            padding: 10px;  
            border-bottom: 1px solid var(--border-color);  
            cursor: pointer;  
            display: flex;  
            justify-content: space-between;  
            align-items: center;  
        }  
        
        .model-item:hover {  
            background-color: rgba(0, 0, 0, 0.05);  
        }  
        
        .model-name {  
            font-weight: bold;  
            font-size: 0.9rem;  
        }  
        
        .model-provider {  
            font-size: 0.8rem;  
            color: #777;  
        }  
        
        .highlighted {  
            background-color: var(--highlight-color);  
            border-radius: 3px;  
            padding: 0 2px;  
        }  
        
        .file-preview {  
            margin-top: 10px;  
            display: flex;  
            gap: 10px;  
            flex-wrap: wrap;  
        }  
        
        .preview-item {  
            position: relative;  
            width: 80px;  
            height: 80px;  
            border-radius: 8px;  
            overflow: hidden;  
            border: 1px solid var(--border-color);  
        }  
        
        .preview-item img {  
            width: 100%;  
            height: 100%;  
            object-fit: cover;  
        }  
        
        .preview-item .file-icon {  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            width: 100%;  
            height: 100%;  
            background-color: var(--message-bot);  
            color: var(--text-color);  
            font-size: 2rem;  
        }  
        
        .remove-file {  
            position: absolute;  
            top: 2px;  
            right: 2px;  
            background-color: rgba(255, 82, 82, 0.8);  
            color: white;  
            border: none;  
            width: 20px;  
            height: 20px;  
            border-radius: 50%;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            font-size: 0.8rem;  
            cursor: pointer;  
        }  
        
        .overlay {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            right: 0;  
            bottom: 0;  
            background-color: rgba(0, 0, 0, 0.5);  
            z-index: 999;  
        }  
        
        .modal {  
            display: none;  
            position: fixed;  
            top: 50%;  
            left: 50%;  
            transform: translate(-50%, -50%);  
            background-color: var(--bg-color);  
            padding: 20px;  
            border-radius: 10px;  
            z-index: 1000;  
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);  
            width: 300px;  
            max-width: 90%;  
        }  
        
        .modal-title {  
            font-family: 'B Titr', tahoma, Arial, sans-serif;  
            font-size: 1.2rem;  
            margin-bottom: 15px;  
            color: var(--text-color);  
        }  
        
        .modal-buttons {  
            display: flex;  
            justify-content: flex-end;  
            gap: 10px;  
            margin-top: 20px;  
        }  
        
        .modal-button {  
            padding: 8px 15px;  
            border-radius: 5px;  
            border: none;  
            cursor: pointer;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
        }  
        
        .cancel-button {  
            background-color: #ddd;  
            color: #333;  
        }  
        
        .confirm-button {  
            background-color: #ff5252;  
            color: white;  
        }  
        
        .theme-toggle {  
            position: fixed;  
            top: 70px;  
            left: 20px;  
            width: 45px;  
            height: 45px;  
            background: none;  
            color: var(--text-color); /* رنگ متضاد با زمینه */  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            cursor: pointer;  
            border: none;  
            font-size: 1.5rem;  
            z-index: 100;  
        }  
        
        .file-input {  
            display: none;  
        }  
        
        .developer-info {  
            position: fixed;  
            bottom: 10px;  
            right: 10px;  
            font-size: 0.7rem;  
            color: #777;  
            opacity: 0.7;  
            z-index: 50;  
        }  
        
        .api-status {  
            display: flex;  
            align-items: center;  
            gap: 5px;  
        }  

        .status-dot {  
            width: 10px;  
            height: 10px;  
            border-radius: 50%;  
            display: inline-block;  
        }  

        .status-dot.green {  
            background-color: #2ecc71;  
        }  

        .status-dot.red {  
            background-color: #e74c3c;  
        }  

        .new-chat-btn, .save-btn {  
            background-color: var(--primary-color);  
            color: white;  
            border: none;  
            padding: 8px 15px;  
            border-radius: 20px;  
            cursor: pointer;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
        }  

        .tone-select {  
            padding: 8px;  
            border: 1px solid var(--border-color);  
            border-radius: 10px;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
            background-color: var(--bg-color);  
            color: var(--text-color);  
        }  

        .edit-input {  
            width: 100%;  
            padding: 5px;  
            margin-top: 5px;  
            border: 1px solid var(--border-color);  
            border-radius: 5px;  
            font-family: 'B Nazanin', tahoma, Arial, sans-serif;  
        }  

        @media (max-width: 768px) {  
            .message {  
                max-width: 85%;  
            }  
            .side-menu {  
                width: 85%;  
                right: -85%;  
            }  
        }  
        
        @media (max-width: 480px) {  
            .header h1 {  
                font-size: 1.2rem;  
            }  
            .message {  
                max-width: 90%;  
                padding: 10px 12px;  
            }  
            .tool-button {  
                font-size: 1rem;  
                padding: 3px 8px;  
            }  
        }  
    </style>  
</head>  
<body>  
    <div class="container">  
        <div class="header">  
            <button class="menu-btn" id="menuBtn">  
                <i class="fas fa-bars"></i>  
            </button>  
            <h1><i class="fas fa-robot"></i> چت بات هوشمند</h1>  
            <div class="header-icons">  
                <button id="modelSelectBtn"><i class="fas fa-cog"></i></button>  
                <button id="clearChatBtn"><i class="fas fa-trash"></i></button>  
                <button class="new-chat-btn" id="newChatBtn">چت جدید</button>  
            </div>  
        </div>  
        
        <div class="chat-container" id="chatContainer">  
            <div class="message bot-message">  
                <div class="message-content">سلام، چطور می‌توانم به شما کمک کنم؟</div>  
                <div class="message-time">اکنون</div>  
                <div class="message-stats">  
                    کلمات: 6 | کاراکتر: 33 | توکن: 12 | جمله: 1  
                </div>  
                <div class="message-actions">  
                    <button class="delete-message"><i class="fas fa-trash"></i></button>  
                </div>  
            </div>  
        </div>  
        
        <div class="input-container">  
            <div class="input-tools">  
                <button class="tool-button" id="uploadBtn">  
                    <i class="fas fa-image"></i>  
                </button>  
                <button class="tool-button" id="fileBtn">  
                    <i class="fas fa-paperclip"></i>  
                </button>  
                <select id="toneSelect" class="tone-select">  
                    <option value="formal">رسمی</option>  
                    <option value="informal">غیررسمی</option>  
                    <option value="friendly">دوستانه</option>  
                    <option value="professional">حرفه‌ای</option>  
                    <option value="childish">کودکانه</option>  
                    <option value="expert">متخصص اطلاعات</option>  
                    <option value="humorous">طنزگونه</option>  
                </select>  
            </div>  
            <div class="file-preview" id="filePreview"></div>  
            <div class="main-input-area">  
                <textarea class="message-input" id="messageInput" placeholder="از من هر چیزی بپرسید..." rows="1"></textarea>  
                <button class="send-button" id="sendBtn" disabled>  
                    <i class="fas fa-paper-plane"></i>  
                </button>  
            </div>  
            <input type="file" id="imageInput" class="file-input" accept="image/*" multiple>  
            <input type="file" id="documentInput" class="file-input" multiple>  
        </div>  
    </div>  
    
    <div class="side-menu" id="sideMenu">  
        <button class="side-menu-close" id="closeMenuBtn">  
            <i class="fas fa-times"></i>  
        </button>  
        <div class="side-menu-tabs">  
            <div class="side-menu-tab active" data-tab="history">تاریخچه</div>  
            <div class="side-menu-tab" data-tab="models">مدل‌ها</div>  
        </div>  
        <div class="tab-content active" data-tab="history">  
            <div class="search-container">  
                <input type="text" class="search-input" id="searchInput" placeholder="جستجو در تاریخچه...">  
            </div>  
            <div id="historyContainer"></div>  
        </div>  
        <div class="tab-content" data-tab="models">  
            <div id="modelsContainer">  
                <select id="aiModelSelect" style="width: 100%; padding: 8px; margin-bottom: 10px;">  
                    <option value="">مدل را انتخاب کنید</option>  
                    <option value="gemini">Gemini</option>  
                    <option value="openrouter">OpenRouter</option>  
                </select>  
                <div class="model-item">  
                    <div>  
                        <div class="model-name">Gemini</div>  
                        <div class="model-provider">Google</div>  
                    </div>  
                    <div class="api-status">  
                        <span class="status-dot" id="geminiStatus"></span>  
                        <input type="text" id="geminiApiKey" placeholder="کلید API Gemini" style="width: 120px;">  
                    </div>  
                </div>  
                <div class="model-item">  
                    <div>  
                        <div class="model-name">OpenRouter</div>  
                        <div class="model-provider">OpenRouter</div>  
                    </div>  
                    <div class="api-status">  
                        <span class="status-dot" id="openRouterStatus"></span>  
                        <input type="text" id="openRouterApiKey" placeholder="کلید API OpenRouter" style="width: 120px;">  
                    </div>  
                </div>  
                <select id="openRouterModelSelect" style="width: 100%; padding: 8px; margin-top: 10px;"></select>  
                <button class="save-btn" id="saveModelBtn" style="margin-top: 10px;">ذخیره</button>  
            </div>  
        </div>  
    </div>  
    
    <button class="theme-toggle" id="themeToggle">  
        <i class="fas fa-moon"></i>  
    </button>  
    
    <div class="overlay" id="overlay"></div>  
    
    <div class="modal" id="deleteModal">  
        <div class="modal-title">آیا از حذف این پیام اطمینان دارید؟</div>  
        <div class="modal-buttons">  
            <button class="modal-button cancel-button" id="cancelDelete">انصراف</button>  
            <button class="modal-button confirm-button" id="confirmDelete">حذف</button>  
        </div>  
    </div>  
    
    <div class="modal" id="clearModal">  
        <div class="modal-title">آیا از پاک کردن تمام گفتگوها اطمینان دارید؟</div>  
        <div class="modal-buttons">  
            <button class="modal-button cancel-button" id="cancelClear">انصراف</button>  
            <button class="modal-button confirm-button" id="confirmClear">پاک کردن</button>  
        </div>  
    </div>  
    
    <div class="modal" id="editModal">  
        <div class="modal-title">ویرایش پیام</div>  
        <textarea id="editInput" class="edit-input" rows="3"></textarea>  
        <div class="modal-buttons">  
            <button class="modal-button cancel-button" id="cancelEdit">انصراف</button>  
            <button class="modal-button confirm-button" id="confirmEdit">ذخیره</button>  
        </div>  
    </div>  
    
    <div class="developer-info">  
        توسعه دهنده: احسان شمسی  
    </div>  

    <script>  
        document.addEventListener('DOMContentLoaded', function() {  
            const messageInput = document.getElementById('messageInput');  
            const sendBtn = document.getElementById('sendBtn');  
            const chatContainer = document.getElementById('chatContainer');  
            const menuBtn = document.getElementById('menuBtn');  
            const closeMenuBtn = document.getElementById('closeMenuBtn');  
            const sideMenu = document.getElementById('sideMenu');  
            const overlay = document.getElementById('overlay');  
            const tabButtons = document.querySelectorAll('.side-menu-tab');  
            const tabContents = document.querySelectorAll('.tab-content');  
            const themeToggle = document.getElementById('themeToggle');  
            const historyContainer = document.getElementById('historyContainer');  
            const modelsContainer = document.getElementById('modelsContainer');  
            const searchInput = document.getElementById('searchInput');  
            const uploadBtn = document.getElementById('uploadBtn');  
            const fileBtn = document.getElementById('fileBtn');  
            const imageInput = document.getElementById('imageInput');  
            const documentInput = document.getElementById('documentInput');  
            const filePreview = document.getElementById('filePreview');  
            const clearChatBtn = document.getElementById('clearChatBtn');  
            const deleteModal = document.getElementById('deleteModal');  
            const clearModal = document.getElementById('clearModal');  
            const editModal = document.getElementById('editModal');  
            const cancelDelete = document.getElementById('cancelDelete');  
            const confirmDelete = document.getElementById('confirmDelete');  
            const cancelClear = document.getElementById('cancelClear');  
            const confirmClear = document.getElementById('confirmClear');  
            const cancelEdit = document.getElementById('cancelEdit');  
            const confirmEdit = document.getElementById('confirmEdit');  
            const editInput = document.getElementById('editInput');  
            const newChatBtn = document.getElementById('newChatBtn');  
            const geminiApiKey = document.getElementById('geminiApiKey');  
            const openRouterApiKey = document.getElementById('openRouterApiKey');  
            const geminiStatus = document.getElementById('geminiStatus');  
            const openRouterStatus = document.getElementById('openRouterStatus');  
            const openRouterModelSelect = document.getElementById('openRouterModelSelect');  
            const aiModelSelect = document.getElementById('aiModelSelect');  
            const toneSelect = document.getElementById('toneSelect');  
            const saveModelBtn = document.getElementById('saveModelBtn');  
            
            let currentTheme = localStorage.getItem('theme') || 'light';  
            let messageToDelete = null;  
            let messageToEdit = null;  
            let uploadedFiles = [];  
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];  
            let selectedApi = localStorage.getItem('selectedApi') || null;  
            let selectedModel = localStorage.getItem('selectedModel') || null;  
            
            if (currentTheme === 'dark') {  
                document.body.classList.add('dark-mode');  
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';  
            }  
            
            messageInput.addEventListener('input', function() {  
                this.style.height = 'auto';  
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';  
                sendBtn.disabled = this.value.trim() === '' && uploadedFiles.length === 0;  
            });  
            
            menuBtn.addEventListener('click', function() {  
                sideMenu.classList.add('active');  
                overlay.style.display = 'block';  
            });  
            
            closeMenuBtn.addEventListener('click', function() {  
                sideMenu.classList.remove('active');  
                overlay.style.display = 'none';  
            });  
            
            overlay.addEventListener('click', function() {  
                sideMenu.classList.remove('active');  
                overlay.style.display = 'none';  
                deleteModal.style.display = 'none';  
                clearModal.style.display = 'none';  
                editModal.style.display = 'none';  
            });  
            
            tabButtons.forEach(button => {  
                button.addEventListener('click', function() {  
                    tabButtons.forEach(btn => btn.classList.remove('active'));  
                    tabContents.forEach(content => content.classList.remove('active'));  
                    this.classList.add('active');  
                    const tabName = this.getAttribute('data-tab');  
                    document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');  
                    if (tabName === 'history') {  
                        updateHistoryView();  
                    } else if (tabName === 'models') {  
                        checkApiStatus();  
                    }  
                });  
            });  
            
            themeToggle.addEventListener('click', function() {  
                if (currentTheme === 'light') {  
                    document.body.classList.add('dark-mode');  
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';  
                    currentTheme = 'dark';  
                } else {  
                    document.body.classList.remove('dark-mode');  
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';  
                    currentTheme = 'light';  
                }  
                localStorage.setItem('theme', currentTheme);  
            });  
            
            sendBtn.addEventListener('click', sendMessage);  
            messageInput.addEventListener('keydown', function(e) {  
                if (e.key === 'Enter' && !e.shiftKey) {  
                    e.preventDefault();  
                    sendMessage();  
                }  
            });  
            
            uploadBtn.addEventListener('click', function() {  
                imageInput.click();  
            });  
            
            imageInput.addEventListener('change', function(e) {  
                handleFileUpload(e.target.files, 'image');  
                this.value = '';  
            });  
            
            fileBtn.addEventListener('click', function() {  
                documentInput.click();  
            });  
            
            documentInput.addEventListener('change', function(e) {  
                handleFileUpload(e.target.files, 'document');  
                this.value = '';  
            });  
            
            searchInput.addEventListener('input', function() {  
                const searchTerm = this.value.trim().toLowerCase();  
                updateHistoryView(searchTerm);  
            });  
            
            clearChatBtn.addEventListener('click', function() {  
                clearModal.style.display = 'block';  
                overlay.style.display = 'block';  
            });  
            
            cancelClear.addEventListener('click', function() {  
                clearModal.style.display = 'none';  
                overlay.style.display = 'none';  
            });  
            
            confirmClear.addEventListener('click', function() {  
                chatContainer.innerHTML = '';  
                addMessage('سلام، چطور می‌توانم به شما کمک کنم؟', 'bot');  
                clearModal.style.display = 'none';  
                overlay.style.display = 'none';  
            });  
            
            newChatBtn.addEventListener('click', function() {  
                chatContainer.innerHTML = '';  
                addMessage('چت جدید شروع شد. چطور می‌توانم کمک کنم؟', 'bot');  
            });  
            
            cancelDelete.addEventListener('click', function() {  
                deleteModal.style.display = 'none';  
                overlay.style.display = 'none';  
                messageToDelete = null;  
            });  
            
            confirmDelete.addEventListener('click', function() {  
                if (messageToDelete) {  
                    const index = chatHistory.findIndex(msg => msg.timestamp === messageToDelete.dataset.timestamp);  
                    if (index !== -1) chatHistory.splice(index, 1);  
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));  
                    messageToDelete.remove();  
                    deleteModal.style.display = 'none';  
                    overlay.style.display = 'none';  
                    updateHistoryView();  
                    messageToDelete = null;  
                }  
            });  
            
            cancelEdit.addEventListener('click', function() {  
                editModal.style.display = 'none';  
                overlay.style.display = 'none';  
                messageToEdit = null;  
            });  
            
            confirmEdit.addEventListener('click', function() {  
                if (messageToEdit) {  
                    const newContent = editInput.value.trim();  
                    const index = chatHistory.findIndex(msg => msg.timestamp === messageToEdit.dataset.timestamp);  
                    if (index !== -1) {  
                        chatHistory[index].content = newContent;  
                        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));  
                        messageToEdit.querySelector('.history-content span').textContent = newContent;  
                    }  
                    editModal.style.display = 'none';  
                    overlay.style.display = 'none';  
                    updateHistoryView();  
                    messageToEdit = null;  
                }  
            });  
            
            geminiApiKey.addEventListener('input', function() {  
                checkGeminiApi(this.value);  
            });  

            openRouterApiKey.addEventListener('input', function() {  
                fetchOpenRouterModels(this.value);  
            });  

            openRouterModelSelect.addEventListener('change', function() {  
                selectedModel = this.value;  
                selectedApi = 'openrouter';  
            });  

            aiModelSelect.addEventListener('change', function() {  
                selectedApi = this.value;  
                if (selectedApi === 'openrouter' && openRouterApiKey.value) {  
                    fetchOpenRouterModels(openRouterApiKey.value);  
                } else if (selectedApi === 'gemini' && geminiApiKey.value) {  
                    checkGeminiApi(geminiApiKey.value);  
                }  
            });  

            saveModelBtn.addEventListener('click', function() {  
                localStorage.setItem('selectedApi', selectedApi);  
                localStorage.setItem('selectedModel', selectedModel);  
                localStorage.setItem('geminiApiKey', geminiApiKey.value);  
                localStorage.setItem('openRouterApiKey', openRouterApiKey.value);  
                addMessage('تنظیمات مدل ذخیره شد.', 'bot');  
            });  
            
            function sendMessage() {  
                const message = messageInput.value.trim();  
                const tone = toneSelect.value;  
                if (message === '' && uploadedFiles.length === 0) return;  
                
                const userMessageElement = addMessage(message, 'user', uploadedFiles);  
                const messageObj = {  
                    content: message,  
                    type: 'user',  
                    files: uploadedFiles.map(file => ({  
                        name: file.name,  
                        type: file.type,  
                        isImage: file.type.startsWith('image/')  
                    })),  
                    timestamp: new Date().toISOString()  
                };  
                chatHistory.push(messageObj);  
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));  
                
                messageInput.value = '';  
                messageInput.style.height = 'auto';  
                uploadedFiles = [];  
                filePreview.innerHTML = '';  
                sendBtn.disabled = true;  
                
                if (selectedApi === 'gemini' && geminiApiKey.value) {  
                    fetchGeminiResponse(message, geminiApiKey.value, tone);  
                } else if (selectedApi === 'openrouter' && selectedModel && openRouterApiKey.value) {  
                    fetchOpenRouterResponse(message, openRouterApiKey.value, selectedModel, tone);  
                } else {  
                    typeMessage('لطفاً یک مدل را انتخاب کنید و کلید API را وارد کنید.', 'bot');  
                }  
                
                chatContainer.scrollTop = chatContainer.scrollHeight;  
            }  
            
            function addMessage(content, type, files = []) {  
                const messageElement = document.createElement('div');  
                messageElement.className = `message ${type}-message`;  
                messageElement.dataset.timestamp = new Date().toISOString();  
                
                let messageHTML = `<div class="message-content"></div>`;  
                if (files.length > 0) {  
                    let filesHTML = '<div class="file-preview">';  
                    files.forEach(file => {  
                        if (file.type.startsWith('image/')) {  
                            filesHTML += `<div class="preview-item"><img src="${file.preview}" alt="${file.name}"></div>`;  
                        } else {  
                            filesHTML += `<div class="preview-item"><div class="file-icon"><i class="fas fa-file"></i></div></div>`;  
                        }  
                    });  
                    filesHTML += '</div>';  
                    messageHTML = filesHTML + messageHTML;  
                }  
                
                const stats = calculateTextStats(content);  
                messageHTML += `  
                    <div class="message-time">${getCurrentTime()}</div>  
                    <div class="message-stats">کلمات: ${stats.words} | کاراکتر: ${stats.characters} | توکن: ${stats.tokens} | جمله: ${stats.sentences}</div>  
                    <div class="message-actions">  
                        <button class="delete-message"><i class="fas fa-trash"></i></button>  
                    </div>  
                `;  
                
                messageElement.innerHTML = messageHTML;  
                const deleteBtn = messageElement.querySelector('.delete-message');  
                deleteBtn.addEventListener('click', function() {  
                    messageToDelete = messageElement;  
                    deleteModal.style.display = 'block';  
                    overlay.style.display = 'block';  
                });  
                
                chatContainer.appendChild(messageElement);  
                typeMessage(content, type, messageElement);  
                return messageElement;  
            }  
            
            function typeMessage(content, type, element = null) {  
                if (!element) {  
                    element = addMessage('', type);  
                }  
                const contentDiv = element.querySelector('.message-content');  
                let index = 0;  
                const speed = 50; // سرعت تایپ (میلی‌ثانیه برای هر حرف)  
                
                function type() {  
                    if (index < content.length) {  
                        contentDiv.textContent += content[index];  
                        index++;  
                        setTimeout(type, speed);  
                    } else {  
                        const messageObj = { content: content, type: type, timestamp: new Date().toISOString() };  
                        chatHistory.push(messageObj);  
                        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));  
                    }  
                }  
                type();  
            }  
            
            function handleFileUpload(files, type) {  
                for (let file of files) {  
                    if (file.type.startsWith('image/')) {  
                        const reader = new FileReader();  
                        reader.onload = function(e) {  
                            const img = new Image();  
                            img.src = e.target.result;  
                            img.onload = function() {  
                                const canvas = document.createElement('canvas');  
                                const ctx = canvas.getContext('2d');  
                                const MAX_WIDTH = 800;  
                                const MAX_HEIGHT = 600;  
                                let width = img.width;  
                                let height = img.height;  
                                if (width > height) {  
                                    if (width > MAX_WIDTH) {  
                                        height *= MAX_WIDTH / width;  
                                        width = MAX_WIDTH;  
                                    }  
                                } else {  
                                    if (height > MAX_HEIGHT) {  
                                        width *= MAX_HEIGHT / height;  
                                        height = MAX_HEIGHT;  
                                    }  
                                }  
                                canvas.width = width;  
                                canvas.height = height;  
                                ctx.drawImage(img, 0, 0, width, height);  
                                const compressedImage = canvas.toDataURL('image/jpeg', 0.7);  
                                uploadedFiles.push({ name: file.name, type: file.type, preview: compressedImage, data: compressedImage });  
                                addFilePreview(file.name, compressedImage, true);  
                                sendBtn.disabled = false;  
                            };  
                        };  
                        reader.readAsDataURL(file);  
                    } else {  
                        uploadedFiles.push({ name: file.name, type: file.type, preview: null, data: null });  
                        addFilePreview(file.name, null, false);  
                        sendBtn.disabled = false;  
                    }  
                }  
            }  
            
            function addFilePreview(fileName, previewURL, isImage) {  
                const previewItem = document.createElement('div');  
                previewItem.className = 'preview-item';  
                if (isImage) {  
                    previewItem.innerHTML = `<img src="${previewURL}" alt="${fileName}"><button class="remove-file"><i class="fas fa-times"></i></button>`;  
                } else {  
                    previewItem.innerHTML = `<div class="file-icon"><i class="fas fa-file"></i></div><button class="remove-file"><i class="fas fa-times"></i></button>`;  
                }  
                const removeBtn = previewItem.querySelector('.remove-file');  
                removeBtn.addEventListener('click', function() {  
                    const fileIndex = uploadedFiles.findIndex(file => file.name === fileName);  
                    if (fileIndex !== -1) uploadedFiles.splice(fileIndex, 1);  
                    previewItem.remove();  
                    sendBtn.disabled = messageInput.value.trim() === '' && uploadedFiles.length === 0;  
                });  
                filePreview.appendChild(previewItem);  
            }  
            
            function updateHistoryView(searchTerm = '') {  
                historyContainer.innerHTML = '';  
                if (chatHistory.length === 0) {  
                    historyContainer.innerHTML = '<div style="padding: 15px; text-align: center;">تاریخچه‌ای وجود ندارد</div>';  
                    return;  
                }  
                
                const groupedHistory = [];  
                let currentGroup = null;  
                chatHistory.forEach((message, index) => {  
                    if (message.type === 'user') {  
                        if (currentGroup) groupedHistory.push(currentGroup);  
                        currentGroup = { user: message, bot: null, timestamp: message.timestamp };  
                    } else if (message.type === 'bot' && currentGroup) {  
                        currentGroup.bot = message;  
                        groupedHistory.push(currentGroup);  
                        currentGroup = null;  
                    }  
                });  
                if (currentGroup) groupedHistory.push(currentGroup);  
                
                groupedHistory.reverse().forEach(group => {  
                    const userContent = group.user.content;  
                    const botContent = group.bot ? group.bot.content : '';  
                    if (searchTerm && !userContent.toLowerCase().includes(searchTerm) && !botContent.toLowerCase().includes(searchTerm)) return;  
                    
                    const historyItem = document.createElement('div');  
                    historyItem.className = 'history-message';  
                    historyItem.dataset.timestamp = group.timestamp;  
                    let displayUserContent = userContent;  
                    let displayBotContent = botContent;  
                    if (searchTerm) {  
                        const regex = new RegExp(searchTerm, 'gi');  
                        displayUserContent = userContent.replace(regex, match => `<span class="highlighted">${match}</span>`);  
                        displayBotContent = botContent.replace(regex, match => `<span class="highlighted">${match}</span>`);  
                    }  
                    
                    let filesHTML = '';  
                    if (group.user.files && group.user.files.length > 0) {  
                        filesHTML = '<div class="history-files">[فایل‌ها: ' + group.user.files.length + ']</div>';  
                    }  
                    
                    historyItem.innerHTML = `  
                        <div class="history-content">${filesHTML}کاربر: <span>${displayUserContent}</span></div>  
                        ${group.bot ? `<div class="history-content">ربات: <span>${displayBotContent}</span></div>` : ''}  
                        <div class="history-date">${formatDate(group.timestamp)}</div>  
                        <button class="edit-history" style="margin-top: 5px;"><i class="fas fa-edit"></i></button>  
                        <button class="delete-history" style="margin-top: 5px;"><i class="fas fa-trash"></i></button>  
                    `;  
                    
                    historyItem.querySelector('.edit-history').addEventListener('click', function() {  
                        messageToEdit = historyItem;  
                        editInput.value = userContent;  
                        editModal.style.display = 'block';  
                        overlay.style.display = 'block';  
                    });  
                    
                    historyItem.querySelector('.delete-history').addEventListener('click', function() {  
                        messageToDelete = historyItem;  
                        deleteModal.style.display = 'block';  
                        overlay.style.display = 'block';  
                    });  
                    
                    historyContainer.appendChild(historyItem);  
                });  
            }  
            
            function checkGeminiApi(apiKey) {  
                fetch('https://generativelanguage.googleapis.com/v1beta/models?key=' + apiKey)  
                    .then(response => {  
                        if (response.ok) {  
                            geminiStatus.classList.remove('red');  
                            geminiStatus.classList.add('green');  
                            typeMessage('اتصال به Gemini با موفقیت انجام شد.', 'bot');  
                        } else {  
                            throw new Error('اتصال ناموفق');  
                        }  
                    })  
                    .catch(error => {  
                        geminiStatus.classList.remove('green');  
                        geminiStatus.classList.add('red');  
                        typeMessage('خطا در اتصال به Gemini: ' + error.message, 'bot');  
                    });  
            }  

            function fetchOpenRouterModels(apiKey) {  
                fetch('https://openrouter.ai/api/v1/models', {  
                    headers: { 'Authorization': `Bearer ${apiKey}` }  
                })  
                    .then(response => {  
                        if (response.ok) {  
                            return response.json();  
                        } else {  
                            throw new Error('اتصال ناموفق');  
                        }  
                    })  
                    .then(data => {  
                        openRouterStatus.classList.remove('red');  
                        openRouterStatus.classList.add('green');  
                        typeMessage('اتصال به OpenRouter با موفقیت انجام شد.', 'bot');  
                        updateOpenRouterModelList(data.data);  
                    })  
                    .catch(error => {  
                        openRouterStatus.classList.remove('green');  
                        openRouterStatus.classList.add('red');  
                        typeMessage('خطا در اتصال به OpenRouter: ' + error.message, 'bot');  
                    });  
            }  

            function updateOpenRouterModelList(models) {  
                openRouterModelSelect.innerHTML = '<option value="">یک مدل انتخاب کنید</option>';  
                models.forEach(model => {  
                    const option = document.createElement('option');  
                    option.value = model.id;  
                    option.text = model.name;  
                    openRouterModelSelect.appendChild(option);  
                });  
            }  

            function fetchGeminiResponse(message, apiKey, tone) {  
                const tonePrompt = getTonePrompt(tone);  
                fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {  
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json' },  
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${tonePrompt} ${message}` }] }] })  
                })  
                    .then(response => response.json())  
                    .then(data => {  
                        const botResponse = data.candidates[0].content.parts[0].text;  
                        typeMessage(botResponse, 'bot');  
                    })  
                    .catch(error => {  
                        typeMessage('خطا در دریافت پاسخ از Gemini: ' + error.message, 'bot');  
                    });  
            }  

            function fetchOpenRouterResponse(message, apiKey, model, tone) {  
                const tonePrompt = getTonePrompt(tone);  
                fetch('https://openrouter.ai/api/v1/chat/completions', {  
                    method: 'POST',  
                    headers: {  
                        'Authorization': `Bearer ${apiKey}`,  
                        'Content-Type': 'application/json'  
                    },  
                    body: JSON.stringify({  
                        model: model,  
                        messages: [{ role: 'user', content: `${tonePrompt} ${message}` }]  
                    })  
                })  
                    .then(response => response.json())  
                    .then(data => {  
                        const botResponse = data.choices[0].message.content;  
                        typeMessage(botResponse, 'bot');  
                    })  
                    .catch(error => {  
                        typeMessage('خطا در دریافت پاسخ از OpenRouter: ' + error.message, 'bot');  
                    });  
            }  

            function getTonePrompt(tone) {  
                switch (tone) {  
                    case 'formal': return 'با لحن رسمی و محترمانه پاسخ بده:';  
                    case 'informal': return 'با لحن غیررسمی و خودمونی پاسخ بده:';  
                    case 'friendly': return 'با لحن دوستانه و گرم پاسخ بده:';  
                    case 'professional': return 'با لحن حرفه‌ای و تخصصی پاسخ بده:';  
                    case 'childish': return 'با لحن کودکانه و ساده پاسخ بده:';  
                    case 'expert': return 'با لحن متخصص و اطلاعاتی پاسخ بده:';  
                    case 'humorous': return 'با لحن طنزگونه و بامزه پاسخ بده:';  
                    default: return '';  
                }  
            }  

            function checkApiStatus() {  
                if (geminiApiKey.value) checkGeminiApi(geminiApiKey.value);  
                if (openRouterApiKey.value) fetchOpenRouterModels(openRouterApiKey.value);  
            }  
            
            function calculateTextStats(text) {  
                if (!text) return { words: 0, characters: 0, tokens: 0, sentences: 0 };  
                const words = text.trim().split(/\s+/).length;  
                const characters = text.length;  
                const tokens = Math.ceil(characters / 4);  
                const sentences = (text.match(/[.!?؟]+/g) || []).length + 1;  
                return { words, characters, tokens, sentences };  
            }  
            
            function getCurrentTime() {  
                const now = new Date();  
                return now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });  
            }  
            
            function formatDate(dateString) {  
                const date = new Date(dateString);  
                return date.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });  
            }  
        });  
    </script>  
</body>  
</html>